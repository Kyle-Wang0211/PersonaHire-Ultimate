// ğŸš€ PersonaHire Ultimate - ä¸»ä¸šåŠ¡é€»è¾‘
// æ•´åˆæ‰€æœ‰æ¨¡å—ï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£

class PersonaHireApp {
    constructor() {
        this.isInitialized = false;
        this.modules = {};
    }

    // ğŸ”§ åº”ç”¨åˆå§‹åŒ–
    async init() {
        try {
            console.log('ğŸš€ PersonaHire Ultimate å¯åŠ¨ä¸­...');
            
            // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
            await this.initializeModules();
            
            // è®¾ç½®ç•Œé¢
            this.setupInterface();
            
            // ç»‘å®šäº‹ä»¶
            this.bindEvents();
            
            // åº”ç”¨å¯åŠ¨å®Œæˆ
            this.isInitialized = true;
            console.log('âœ… PersonaHire Ultimate å¯åŠ¨å®Œæˆ');
            
        } catch (error) {
            console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
            this.showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }

    // ğŸ“¦ æ¨¡å—åˆå§‹åŒ–
    async initializeModules() {
        // åˆå§‹åŒ–å®‰å…¨ç³»ç»Ÿ
        if (typeof initializeSecurity === 'function') {
            this.modules.security = initializeSecurity();
            console.log('ğŸ›¡ï¸ å®‰å…¨æ¨¡å—åŠ è½½:', this.modules.security ? 'æˆåŠŸ' : 'å¤±è´¥');
        }

        // åˆå§‹åŒ–Tokenç›‘æ§
        if (typeof initializeTokenMonitoring === 'function') {
            this.modules.tokenMonitoring = initializeTokenMonitoring();
            console.log('ğŸ“Š ç›‘æ§æ¨¡å—åŠ è½½:', this.modules.tokenMonitoring ? 'æˆåŠŸ' : 'å¤±è´¥');
        }

        // åˆå§‹åŒ–APIå¯†é’¥
        this.initializeApiKeys();
    }

    // ğŸ”‘ APIå¯†é’¥åˆå§‹åŒ–
    initializeApiKeys() {
        if (isDeveloperMode) {
            // å¼€å‘è€…æ¨¡å¼ï¼šæ˜¾ç¤ºAPIé…ç½®ç•Œé¢
            this.setupDeveloperMode();
        } else {
            // ç”¨æˆ·æ¨¡å¼ï¼šä½¿ç”¨é¢„è®¾å¯†é’¥
            this.setupUserMode();
        }
    }

    // ğŸ”§ å¼€å‘è€…æ¨¡å¼è®¾ç½®
    setupDeveloperMode() {
        document.getElementById('mainContainer').className = 'container dev-mode';
        document.getElementById('devModeLink').textContent = 'ğŸ‘¤ ç”¨æˆ·æ¨¡å¼';
        document.getElementById('devModeLink').href = './';
        document.getElementById('modeBadge').textContent = 'ğŸ”§ å¼€å‘è€…ç›‘æ§ä¸­å¿ƒ';
        document.getElementById('headerDesc').textContent = 'APIé…ç½®å’Œè¯¦ç»†Tokenä½¿ç”¨ç›‘æ§ç³»ç»Ÿ';
        
        // åŠ è½½å·²ä¿å­˜çš„APIå¯†é’¥
        const savedOpenaiKey = localStorage.getItem('openai_api_key');
        const savedElevenKey = localStorage.getItem('eleven_api_key');
        
        if (savedOpenaiKey) {
            document.getElementById('openaiKey').value = savedOpenaiKey;
            openaiKey = savedOpenaiKey;
        }
        
        if (savedElevenKey) {
            document.getElementById('elevenKey').value = savedElevenKey;
            elevenKey = savedElevenKey;
        }
        
        // åˆå§‹åŒ–æ—¥æœŸç­›é€‰å™¨
        this.setupDateFilters();
        
        // åŠ è½½Tokenç»Ÿè®¡
        if (this.modules.tokenMonitoring && typeof TokenMonitoring !== 'undefined') {
            TokenMonitoring.refreshStats();
        }
    }

    // ğŸ‘¤ ç”¨æˆ·æ¨¡å¼è®¾ç½®
    setupUserMode() {
        document.getElementById('mainContainer').className = 'container';
        document.getElementById('modeBadge').textContent = 'âœ¨ å³å¼€å³ç”¨ç‰ˆ';
        document.getElementById('modeBadge').style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
        
        openaiKey = API_CONFIG.DEFAULT_OPENAI_KEY;
        elevenKey = API_CONFIG.DEFAULT_ELEVEN_KEY;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é¢„è®¾å¯†é’¥
        if (openaiKey && openaiKey !== "your-openai-api-key-here") {
            document.getElementById('startBtn').disabled = false;
        } else {
            this.showMessage('âš ï¸ ç³»ç»Ÿæ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 'error');
        }
        
        this.updateWelcomeMessage();
    }

    // ğŸ“… è®¾ç½®æ—¥æœŸç­›é€‰å™¨
    setupDateFilters() {
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        document.getElementById('logDate').value = today;
    }

    // ğŸ¨ ç•Œé¢è®¾ç½®
    setupInterface() {
        // è®¾ç½®æ¬¢è¿æ¶ˆæ¯
        this.updateWelcomeMessage();
    }

    // ğŸ“ æ›´æ–°æ¬¢è¿æ¶ˆæ¯
    updateWelcomeMessage() {
        if (!isDeveloperMode) {
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
            æ¬¢è¿æ¥åˆ°PersonaHire Ultimateï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIé¢è¯•å®˜Sarahã€‚
            <br><br>
            ğŸ¯ <strong>å³å¼€å³ç”¨</strong> - æ— éœ€ä»»ä½•é…ç½®ï¼Œç«‹å³å¼€å§‹ä¸“ä¸šé¢è¯•ä½“éªŒ
            <br>ğŸ¤– <strong>GPT-4.1é©±åŠ¨</strong> - æœ€å…ˆè¿›çš„AIæ¨ç†å¼•æ“
            <br>ğŸµ <strong>çœŸäººè¯­éŸ³</strong> - æ¥è¿‘çœŸå®é¢è¯•å®˜çš„è¯­éŸ³äº¤äº’
            <br>ğŸ“Š <strong>ä¸“ä¸šè¯„ä¼°</strong> - å¤šç»´åº¦é¢è¯•è¡¨ç°åˆ†æ
            <br><br>
            è¯·é€‰æ‹©æ‚¨æƒ³è¦çš„é¢è¯•é£æ ¼å’Œéš¾åº¦ï¼Œç„¶åç‚¹å‡»"å¼€å§‹é¢è¯•"ï¼
            `;
        }
    }

    // ğŸ¯ äº‹ä»¶ç»‘å®š
    bindEvents() {
        // å›è½¦å‘é€æ¶ˆæ¯
        const userInput = document.getElementById('userInput');
        if (userInput) {
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', () => {
            this.saveApplicationState();
        });
    }

    // ğŸ’¾ ä¿å­˜APIå¯†é’¥
    saveApiKeys() {
        const openaiInput = document.getElementById('openaiKey');
        const elevenInput = document.getElementById('elevenKey');
        
        openaiKey = openaiInput.value.trim();
        elevenKey = elevenInput.value.trim();
        
        if (openaiKey && openaiKey.startsWith('sk-')) {
            localStorage.setItem('openai_api_key', openaiKey);
            if (elevenKey) {
                localStorage.setItem('eleven_api_key', elevenKey);
            }
            this.showMessage('âœ… APIé…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
        } else {
            this.showError('è¯·è¾“å…¥æœ‰æ•ˆçš„OpenAI API Key (ä»¥sk-å¼€å¤´)');
        }
    }

    // ğŸ¯ å¼€å§‹é¢è¯•
    async startInterview() {
        if (!this.validateApiKey()) return;

        const style = document.getElementById('interviewerStyle')?.value || 'friendly';
        const difficulty = document.getElementById('difficulty')?.value || 'intermediate';

        const systemPrompt = `${INTERVIEWER_PERSONALITIES[style]}

é¢è¯•éš¾åº¦: ${DIFFICULTY_SETTINGS[difficulty]}

é¢è¯•è§„åˆ™ï¼š
1. ä¸€æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œç­‰å€™é€‰äººå›ç­”å®Œå†é—®ä¸‹ä¸€ä¸ª
2. æ ¹æ®å€™é€‰äººçš„å›ç­”è¿›è¡Œ3-5è½®æ·±åº¦è¿½é—®
3. ä¿æŒå¯¹è¯è¿è´¯ï¼Œæ§åˆ¶åœ¨åˆç†é•¿åº¦å†…
4. æ¯ä¸ªé—®é¢˜éƒ½è¦æœ‰æ˜ç¡®çš„è€ƒå¯Ÿç›®çš„
5. é¢è¯•æ€»æ—¶é•¿æ§åˆ¶åœ¨15-20åˆ†é’Ÿ
6. é€‚æ—¶ç»™äºˆåé¦ˆå’Œé¼“åŠ±

è¯·ç”¨ä¸­æ–‡è¿›è¡Œé¢è¯•ï¼Œä¿æŒä¸“ä¸šä½†å‹å¥½çš„è¯­æ°”ã€‚ç°åœ¨å¼€å§‹ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚`;

        try {
            // é‡ç½®é¢è¯•çŠ¶æ€
            this.resetInterviewState();
            
            // æ›´æ–°UIçŠ¶æ€
            this.setInterviewUIState('starting');
            
            // ä½¿ç”¨å®‰å…¨APIè°ƒç”¨
            const response = await this.secureAPICall([
                { role: 'system', content: systemPrompt },
                { role: 'user', content: 'å¼€å§‹é¢è¯•' }
            ]);
            
            // è®°å½•é¢è¯•å¼€å§‹
            if (typeof TokenMonitoring !== 'undefined') {
                TokenMonitoring.logUsage(0, 'interview_start');
            }
            
            // æ˜¾ç¤ºå“åº”
            this.addMessage(response, 'interviewer');
            await this.playAudio(response);
            
            interviewStarted = true;
            this.setInterviewUIState('active');
            
        } catch (error) {
            this.handleInterviewError('å¯åŠ¨é¢è¯•å¤±è´¥', error);
        }
    }

    // ğŸ’¬ å‘é€æ¶ˆæ¯
    async sendMessage() {
        const userInput = document.getElementById('userInput');
        const message = userInput?.value?.trim();

        if (!message || !interviewStarted) return;

        try {
            this.addMessage(message, 'user');
            userInput.value = '';
            this.setMessageUIState('sending');

            // æ›´æ–°å¯¹è¯å†å²
            conversationHistory.push({ role: 'user', content: message });

            // é™åˆ¶å¯¹è¯å†å²é•¿åº¦
            if (conversationHistory.length > 21) {
                const systemPrompt = conversationHistory[0];
                conversationHistory = [systemPrompt, ...conversationHistory.slice(-20)];
            }

            // å®‰å…¨APIè°ƒç”¨
            const response = await this.secureAPICall(conversationHistory);
            
            conversationHistory.push({ role: 'assistant', content: response });
            this.addMessage(response, 'interviewer');
            await this.playAudio(response);

        } catch (error) {
            this.handleMessageError('å‘é€æ¶ˆæ¯å¤±è´¥', error);
        } finally {
            this.setMessageUIState('ready');
        }
    }

    // ğŸ“Š ç”ŸæˆæŠ¥å‘Š
    async generateReport() {
        if (conversationHistory.length < 4) {
            this.showError('é¢è¯•å†…å®¹å¤ªå°‘ï¼Œæ— æ³•ç”Ÿæˆæœ‰æ•ˆæŠ¥å‘Šã€‚è¯·è‡³å°‘è¿›è¡Œ3è½®å¯¹è¯ã€‚');
            return;
        }

        try {
            this.setUIState('loading', 'æ­£åœ¨ç”Ÿæˆä¸“ä¸šè¯„ä¼°æŠ¥å‘Š...');

            const reportPrompt = `åŸºäºä»¥ä¸Šé¢è¯•å¯¹è¯ï¼Œç”Ÿæˆç®€æ´çš„ä¸“ä¸šè¯„ä¼°æŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š

1. æ•´ä½“è¡¨ç°æ¦‚è¿°ï¼ˆ1-2å¥è¯æ€»ç»“è¡¨ç°ã€ä¼˜åŠ¿å’Œä¸»è¦æå‡ç©ºé—´ï¼‰
2. æ ¸å¿ƒèƒ½åŠ›è¯„ä¼°ï¼ˆæŠ€èƒ½ã€æ²Ÿé€šã€é€»è¾‘æ€ç»´ã€åº”å˜èƒ½åŠ›ç­‰ï¼Œæ¯é¡¹1-10åˆ†+ç®€çŸ­è¯„ä»·ï¼‰
3. ä¸»è¦äº®ç‚¹ï¼ˆ2-3ä¸ªçªå‡ºä¼˜åŠ¿ï¼‰
4. éœ€è¦æ”¹è¿›çš„æ–¹é¢ï¼ˆ2-3ä¸ªå…·ä½“æ”¹è¿›ç‚¹ï¼‰
5. è¯¦ç»†è¯„åˆ†è¡¨æ ¼ï¼ˆ6-8ä¸ªç»´åº¦ï¼Œæ ¼å¼ï¼šç»´åº¦ | å¾—åˆ† | ä¸€å¥è¯è¯„ä»·ï¼‰

è¦æ±‚ï¼šç®€æ´ä¸“ä¸šï¼Œæ€»é•¿åº¦æ§åˆ¶åœ¨400å­—ä»¥å†…ï¼Œé‡ç‚¹çªå‡ºå…³é”®ä¿¡æ¯ã€‚`;

            // åˆ›å»ºæŠ¥å‘Šå†å²
            const reportHistory = [
                conversationHistory[0], // ç³»ç»Ÿæç¤ºè¯
                ...conversationHistory.slice(-8), // æœ€è¿‘4è½®å¯¹è¯
                { role: 'user', content: reportPrompt }
            ];
            
            const report = await this.secureAPICall(reportHistory, { type: 'report' });
            
            this.addMessage(`ğŸ“Š **é¢è¯•è¯„ä¼°æŠ¥å‘Š**\n\n${report}`, 'interviewer');
            await this.playAudio('æ‚¨çš„é¢è¯•è¯„ä¼°æŠ¥å‘Šå·²ç”Ÿæˆå®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†åˆ†æã€‚');
            
            this.showMessage('âœ… é¢è¯•æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼', 'success');

        } catch (error) {
            this.handleError('ç”ŸæˆæŠ¥å‘Šå¤±è´¥', error);
        } finally {
            this.setUIState('ready');
        }
    }

    // ğŸ”’ å®‰å…¨APIè°ƒç”¨
    async secureAPICall(messages, options = {}) {
        if (typeof SecureAPI !== 'undefined' && SecureAPI.callGPT) {
            return await SecureAPI.callGPT(messages, options);
        } else {
            // é™çº§åˆ°åŸºç¡€APIè°ƒç”¨
            return await this.basicAPICall(messages, options);
        }
    }

    // ğŸŒ åŸºç¡€APIè°ƒç”¨ï¼ˆå®‰å…¨é™çº§ï¼‰
    async basicAPICall(messages, options = {}) {
        const response = await fetch(API_CONFIG.OPENAI_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${openaiKey}`,
                'User-Agent': `${APP_CONFIG.name}/${APP_CONFIG.version}`
            },
            body: JSON.stringify({
                model: API_CONFIG.ALLOWED_MODEL,
                messages: messages,
                max_tokens: Math.min(options.max_tokens || 800, API_CONFIG.MAX_TOKENS_PER_REQUEST),
                temperature: 0.7,
                user: `PersonaHire-${Date.now()}`
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = await response.json();
        
        // è®°å½•Tokenä½¿ç”¨
        if (data.usage && typeof TokenMonitoring !== 'undefined') {
            TokenMonitoring.logUsage(data.usage.total_tokens, options.type || 'chat');
        }
        
        return data.choices[0].message.content;
    }

    // ğŸµ æ’­æ”¾éŸ³é¢‘
    async playAudio(text) {
        if (currentAudio) {
            currentAudio.pause();
        }

        try {
            const audioUrl = await this.generateSpeech(text);
            if (audioUrl) {
                currentAudio = new Audio(audioUrl);
                currentAudio.play();
                currentAudio.onended = () => URL.revokeObjectURL(audioUrl);
            }
        } catch (error) {
            console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
        }
    }

    // ğŸ—£ï¸ è¯­éŸ³åˆæˆ
    async generateSpeech(text) {
        if (!elevenKey) {
            return await this.generateOpenAITTS(text);
        }
        return await this.generateElevenLabsTTS(text);
    }

    // ğŸµ OpenAI TTS
    async generateOpenAITTS(text) {
        try {
            const response = await fetch(API_CONFIG.OPENAI_TTS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${openaiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'tts-1',
                    voice: document.getElementById('voiceStyle')?.value || VOICE_CONFIG.DEFAULT_VOICE,
                    input: text,
                    speed: VOICE_CONFIG.TTS_SPEED
                })
            });

            if (response.ok) {
                const audioBlob = await response.blob();
                return URL.createObjectURL(audioBlob);
            }
        } catch (error) {
            console.log('OpenAI TTSå¤±è´¥:', error);
        }
        return null;
    }

    // ğŸµ ElevenLabs TTS
    async generateElevenLabsTTS(text) {
        try {
            const response = await fetch(API_CONFIG.ELEVENLABS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Accept': 'audio/mpeg',
                    'Content-Type': 'application/json',
                    'xi-api-key': elevenKey
                },
                body: JSON.stringify({
                    text: text,
                    model_id: VOICE_CONFIG.ELEVENLABS_MODEL,
                    voice_settings: VOICE_CONFIG.ELEVENLABS_SETTINGS
                })
            });

            if (response.ok) {
                const audioBlob = await response.blob();
                return URL.createObjectURL(audioBlob);
            }
        } catch (error) {
            console.log('ElevenLabs TTSå¤±è´¥:', error);
        }
        return null;
    }

    // ğŸ’¬ æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒº
    addMessage(content, sender) {
        const chatArea = document.getElementById('chatArea');
        if (!chatArea) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const senderName = sender === 'interviewer' ? 'ğŸ­ AIé¢è¯•å®˜ Sarah' : 'ğŸ‘¤ æ‚¨';
        messageDiv.innerHTML = `<strong>${senderName}ï¼š</strong>${content.replace(/\n/g, '<br>')}`;
        
        if (sender === 'interviewer') {
            const voiceControls = document.createElement('div');
            voiceControls.className = 'voice-controls';
            voiceControls.innerHTML = `<button class="voice-btn" onclick="app.playAudio('${content.replace(/'/g, "\\'")}')">ğŸ”Š é‡æ’­è¯­éŸ³</button>`;
            messageDiv.appendChild(voiceControls);
        }
        
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // ğŸ” éªŒè¯API Key
    validateApiKey() {
        if (!openaiKey || (isDeveloperMode && !openaiKey.startsWith('sk-'))) {
            this.showError('è¯·å…ˆé…ç½®OpenAI API Key');
            return false;
        }
        return true;
    }

    // ğŸ”„ é‡ç½®é¢è¯•çŠ¶æ€
    resetInterviewState() {
        currentInterviewTokens = 0;
        currentInterviewStartTime = new Date();
        conversationHistory = [];
        interviewStarted = false;
    }

    // ğŸ¨ UIçŠ¶æ€ç®¡ç†
    setInterviewUIState(state) {
        const elements = {
            startBtn: document.getElementById('startBtn'),
            endBtn: document.getElementById('endBtn'),
            reportBtn: document.getElementById('reportBtn'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            loading: document.getElementById('loading')
        };

        switch (state) {
            case 'starting':
                elements.startBtn.disabled = true;
                elements.loading.style.display = 'block';
                break;
            case 'active':
                elements.endBtn.disabled = false;
                elements.reportBtn.disabled = false;
                elements.userInput.disabled = false;
                elements.sendBtn.disabled = false;
                elements.loading.style.display = 'none';
                break;
            case 'ended':
                elements.startBtn.disabled = false;
                elements.endBtn.disabled = true;
                elements.userInput.disabled = true;
                elements.sendBtn.disabled = true;
                break;
        }
    }

    setMessageUIState(state) {
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');

        switch (state) {
            case 'sending':
                sendBtn.disabled = true;
                loading.style.display = 'block';
                break;
            case 'ready':
                sendBtn.disabled = false;
                loading.style.display = 'none';
                break;
        }
    }

    setUIState(state, message = '') {
        const loading = document.getElementById('loading');
        
        switch (state) {
            case 'loading':
                loading.style.display = 'block';
                if (message) loading.textContent = message;
                break;
            case 'ready':
                loading.style.display = 'none';
                break;
        }
    }

    // ğŸ ç»“æŸé¢è¯•
    endInterview() {
        interviewStarted = false;
        this.setInterviewUIState('ended');
        this.addMessage('é¢è¯•ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼å¦‚éœ€æŸ¥çœ‹è¯¦ç»†è¯„ä¼°ï¼Œè¯·ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®ã€‚', 'interviewer');
        this.playAudio('é¢è¯•ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼');
    }

    // ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯
    clearChat() {
        const chatArea = document.getElementById('chatArea');
        if (chatArea) {
            chatArea.innerHTML = `
                <div class="message interviewer">
                    <strong>ğŸ­ AIé¢è¯•å®˜ Sarahï¼š</strong>
                    æ¬¢è¿æ¥åˆ°PersonaHire Ultimateï¼æˆ‘å·²å‡†å¤‡å¥½å¼€å§‹æ–°çš„é¢è¯•ã€‚è¯·é…ç½®å¥½è®¾ç½®åç‚¹å‡»"å¼€å§‹é¢è¯•"ã€‚
                </div>
            `;
        }
        this.resetInterviewState();
        if (isDeveloperMode && typeof TokenMonitoring !== 'undefined') {
            TokenMonitoring.refreshStats();
        }
    }

    // ğŸµ æ’­æ”¾æ¬¢è¿æ¶ˆæ¯
    async playWelcomeMessage() {
        const welcomeText = "æ¬¢è¿æ¥åˆ°PersonaHire Ultimateï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIé¢è¯•å®˜Sarahã€‚è®©æˆ‘ä»¬å¼€å§‹ä¸€åœºç²¾å½©çš„é¢è¯•å§ï¼";
        await this.playAudio(welcomeText);
    }

    // ğŸ’¾ ä¿å­˜åº”ç”¨çŠ¶æ€
    saveApplicationState() {
        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
        const state = {
            interviewStarted,
            currentInterviewTokens,
            lastUpdate: new Date().toISOString()
        };
        localStorage.setItem('personahire_app_state', JSON.stringify(state));
    }

    // ğŸ“¢ æ¶ˆæ¯æ˜¾ç¤º
    showMessage(message, type = 'info') {
        const statusDiv = document.getElementById('statusMessage');
        if (statusDiv) {
            statusDiv.className = type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }

    showError(message) {
        this.showMessage(message, 'error');
    }

    // ğŸš¨ é”™è¯¯å¤„ç†
    handleInterviewError(message, error) {
        console.error(message, error);
        this.showError(`${message}: ${error.message}`);
        this.setInterviewUIState('ended');
    }

    handleMessageError(message, error) {
        console.error(message, error);
        this.showError(`${message}: ${error.message}`);
        this.addMessage('æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚', 'interviewer');
    }

    handleError(message, error) {
        console.error(message, error);
        this.showError(`${message}: ${error.message}`);
    }
}

// ğŸŒ å…¨å±€åº”ç”¨å®ä¾‹
let app;

// ğŸš€ åº”ç”¨å¯åŠ¨
window.addEventListener('load', async () => {
    try {
        app = new PersonaHireApp();
        await app.init();
        
        // å°†å…³é”®å‡½æ•°ç»‘å®šåˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆä¸ºäº†å…¼å®¹HTMLäº‹ä»¶ï¼‰
        window.saveApiKeys = () => app.saveApiKeys();
        window.startInterview = () => app.startInterview();
        window.sendMessage = () => app.sendMessage();
        window.generateReport = () => app.generateReport();
        window.endInterview = () => app.endInterview();
        window.clearChat = () => app.clearChat();
        window.playWelcomeMessage = () => app.playWelcomeMessage();
        
        // Tokenç›‘æ§ç›¸å…³å‡½æ•°
        if (typeof TokenMonitoring !== 'undefined') {
            window.switchTab = TokenMonitoring.switchTab;
            window.filterByDate = TokenMonitoring.filterByDate;
            window.loadAllDays = TokenMonitoring.loadAllDays;
            window.loadTodayLogs = TokenMonitoring.loadTodayLogs;
            window.loadDayLogs = TokenMonitoring.loadDayLogs;
            window.loadAllLogs = TokenMonitoring.loadAllLogs;
            window.exportToJSON = TokenMonitoring.exportToJSON;
            window.exportToCSV = TokenMonitoring.exportToCSV;
            window.exportDailyStats = TokenMonitoring.exportDailyStats;
            window.clearOldData = TokenMonitoring.clearOldData;
            window.resetAllData = TokenMonitoring.resetAllData;
        }
        
    } catch (error) {
        console.error('âŒ åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
    }
});

console.log('ğŸš€ ä¸»åº”ç”¨æ¨¡å—åŠ è½½å®Œæˆ');