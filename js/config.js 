// PersonaHire Ultimate - é…ç½®ç®¡ç†æ¨¡å—
// è´Ÿè´£APIå¯†é’¥ç®¡ç†ã€æ¨¡å¼æ£€æµ‹ã€ç¯å¢ƒé…ç½®

class ConfigManager {
    constructor() {
        this.isDeveloperMode = window.location.search.includes('dev=true');
        this.apiKeys = {
            openai: '',
            elevenlabs: ''
        };
        this.settings = {
            temperature: 0.7,
            maxTokens: 800,
            presencePenalty: 0.1,
            frequencyPenalty: 0.1,
            tokenOptimization: true,
            smartSummary: true,
            adaptiveDifficulty: false
        };
        this.init();
    }

    init() {
        this.initializeMode();
        this.loadSettings();
        this.bindEvents();
    }

    initializeMode() {
        const modeBadge = document.getElementById('modeBadge');
        const devModeLink = document.getElementById('devModeLink');
        const apiSetup = document.getElementById('apiSetup');

        if (this.isDeveloperMode) {
            // å¼€å‘è€…æ¨¡å¼è®¾ç½®
            apiSetup.style.display = 'block';
            devModeLink.textContent = 'ğŸ‘¤ ç”¨æˆ·æ¨¡å¼';
            devModeLink.href = './';
            modeBadge.textContent = 'ğŸ”§ å¼€å‘è€…æ¨¡å¼';
            modeBadge.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
            
            this.loadApiKeysFromStorage();
        } else {
            // ç”¨æˆ·æ¨¡å¼è®¾ç½®
            apiSetup.style.display = 'none';
            modeBadge.textContent = 'âœ¨ å³å¼€å³ç”¨ç‰ˆ';
            modeBadge.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
            
            // ä½¿ç”¨é¢„è®¾å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼‰
            this.apiKeys.openai = this.getDefaultOpenAIKey();
            this.apiKeys.elevenlabs = this.getDefaultElevenLabsKey();
            
            this.updateWelcomeMessage();
            this.checkApiKeyValidity();
        }
    }

    getDefaultOpenAIKey() {
        // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™åº”è¯¥é€šè¿‡æœåŠ¡å™¨ç«¯æ³¨å…¥
        return "your-openai-api-key-here";
    }

    getDefaultElevenLabsKey() {
        // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™åº”è¯¥é€šè¿‡æœåŠ¡å™¨ç«¯æ³¨å…¥
        return "your-elevenlabs-api-key-here";
    }

    loadApiKeysFromStorage() {
        const savedOpenAI = localStorage.getItem('openai_api_key');
        const savedElevenLabs = localStorage.getItem('eleven_api_key');
        
        if (savedOpenAI) {
            document.getElementById('openaiKey').value = savedOpenAI;
            this.apiKeys.openai = savedOpenAI;
            document.getElementById('startBtn').disabled = false;
        }
        
        if (savedElevenLabs) {
            document.getElementById('elevenKey').value = savedElevenLabs;
            this.apiKeys.elevenlabs = savedElevenLabs;
        }
    }

    saveApiKeys() {
        const openaiInput = document.getElementById('openaiKey');
        const elevenInput = document.getElementById('elevenKey');
        
        const openaiKey = openaiInput.value.trim();
        const elevenKey = elevenInput.value.trim();
        
        if (openaiKey && openaiKey.startsWith('sk-')) {
            localStorage.setItem('openai_api_key', openaiKey);
            this.apiKeys.openai = openaiKey;
            
            if (elevenKey) {
                localStorage.setItem('eleven_api_key', elevenKey);
                this.apiKeys.elevenlabs = elevenKey;
            }
            
            window.uiManager.showMessage('âœ… APIé…ç½®ä¿å­˜æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹ç»ˆæé¢è¯•ä½“éªŒäº†ã€‚', 'success');
            document.getElementById('startBtn').disabled = false;
        } else {
            window.uiManager.showError('è¯·è¾“å…¥æœ‰æ•ˆçš„OpenAI API Key (ä»¥sk-å¼€å¤´)');
        }
    }

    checkApiKeyValidity() {
        if (!this.isDeveloperMode) {
            if (this.apiKeys.openai && this.apiKeys.openai !== "your-openai-api-key-here") {
                document.getElementById('startBtn').disabled = false;
            } else {
                window.uiManager.showMessage('âš ï¸ ç³»ç»Ÿæ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 'warning');
            }
        }
    }

    updateWelcomeMessage() {
        if (!this.isDeveloperMode) {
            const welcomeMsg = document.getElementById('welcomeMessage');
            welcomeMsg.innerHTML = `
            æ¬¢è¿æ¥åˆ°PersonaHire Ultimateï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIé¢è¯•å®˜Sarahã€‚
            <br><br>
            ğŸ¯ <strong>å³å¼€å³ç”¨</strong> - æ— éœ€ä»»ä½•é…ç½®ï¼Œç«‹å³å¼€å§‹ä¸“ä¸šé¢è¯•ä½“éªŒ
            <br>ğŸ¤– <strong>GPT-4.1é©±åŠ¨</strong> - æœ€å…ˆè¿›çš„AIæ¨ç†å¼•æ“
            <br>ğŸµ <strong>çœŸäººè¯­éŸ³</strong> - æ¥è¿‘çœŸå®é¢è¯•å®˜çš„è¯­éŸ³äº¤äº’
            <br>ğŸ“Š <strong>ä¸“ä¸šè¯„ä¼°</strong> - å¤šç»´åº¦é¢è¯•è¡¨ç°åˆ†æ
            <br>ğŸ” <strong>æ™ºèƒ½ä¼˜åŒ–</strong> - Tokenä½¿ç”¨ä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶
            <br><br>
            è¯·é€‰æ‹©æ‚¨æƒ³è¦çš„é¢è¯•é£æ ¼å’Œéš¾åº¦ï¼Œç„¶åç‚¹å‡»"å¼€å§‹é¢è¯•"ï¼
            `;
        }
    }

    loadSettings() {
        const savedSettings = localStorage.getItem('persona_hire_settings');
        if (savedSettings) {
            this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
        this.applySettings();
    }

    saveSettings() {
        localStorage.setItem('persona_hire_settings', JSON.stringify(this.settings));
    }

    applySettings() {
        // åº”ç”¨æ¸©åº¦è®¾ç½®
        const tempSlider = document.getElementById('temperature');
        const tempValue = document.getElementById('tempValue');
        if (tempSlider) {
            tempSlider.value = this.settings.temperature;
            tempValue.textContent = this.settings.temperature;
        }

        // åº”ç”¨æœ€å¤§Tokenè®¾ç½®
        const maxTokensSlider = document.getElementById('maxTokens');
        const maxTokensValue = document.getElementById('maxTokensValue');
        if (maxTokensSlider) {
            maxTokensSlider.value = this.settings.maxTokens;
            maxTokensValue.textContent = this.settings.maxTokens;
        }

        // åº”ç”¨Presence Penaltyè®¾ç½®
        const presenceSlider = document.getElementById('presencePenalty');
        const presenceValue = document.getElementById('presenceValue');
        if (presenceSlider) {
            presenceSlider.value = this.settings.presencePenalty;
            presenceValue.textContent = this.settings.presencePenalty;
        }

        // åº”ç”¨åŠŸèƒ½å¼€å…³çŠ¶æ€
        this.updateToggleButtons();
    }

    updateToggleButtons() {
        const buttons = {
            'tokenOptimizeBtn': this.settings.tokenOptimization,
            'smartSummaryBtn': this.settings.smartSummary,
            'adaptiveDifficultyBtn': this.settings.adaptiveDifficulty
        };

        Object.entries(buttons).forEach(([id, active]) => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.classList.toggle('active', active);
            }
        });
    }

    updateSetting(key, value) {
        this.settings[key] = value;
        this.saveSettings();
    }

    bindEvents() {
        // ç»‘å®šè®¾ç½®æ›´æ–°äº‹ä»¶
        window.updateTemperature = () => {
            const value = parseFloat(document.getElementById('temperature').value);
            document.getElementById('tempValue').textContent = value;
            this.updateSetting('temperature', value);
        };

        window.updateMaxTokens = () => {
            const value = parseInt(document.getElementById('maxTokens').value);
            document.getElementById('maxTokensValue').textContent = value;
            this.updateSetting('maxTokens', value);
        };

        window.updatePresencePenalty = () => {
            const value = parseFloat(document.getElementById('presencePenalty').value);
            document.getElementById('presenceValue').textContent = value;
            this.updateSetting('presencePenalty', value);
        };

        window.toggleTokenOptimization = () => {
            this.settings.tokenOptimization = !this.settings.tokenOptimization;
            this.updateSetting('tokenOptimization', this.settings.tokenOptimization);
            this.updateToggleButtons();
        };

        window.toggleSmartSummary = () => {
            this.settings.smartSummary = !this.settings.smartSummary;
            this.updateSetting('smartSummary', this.settings.smartSummary);
            this.updateToggleButtons();
        };

        window.toggleAdaptiveDifficulty = () => {
            this.settings.adaptiveDifficulty = !this.settings.adaptiveDifficulty;
            this.updateSetting('adaptiveDifficulty', this.settings.adaptiveDifficulty);
            this.updateToggleButtons();
        };

        // å…¨å±€ä¿å­˜APIå¯†é’¥å‡½æ•°
        window.saveApiKeys = () => this.saveApiKeys();
    }

    // è·å–å½“å‰GPTè¯·æ±‚é…ç½®
    getGPTConfig() {
        return {
            model: 'gpt-4.1',
            temperature: this.settings.temperature,
            max_tokens: this.settings.maxTokens,
            presence_penalty: this.settings.presencePenalty,
            frequency_penalty: this.settings.frequencyPenalty
        };
    }

    // é¢è¯•å®˜äººè®¾åº“
    getInterviewerPersonalities() {
        return {
            professional: `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æŠ€æœ¯æ€»ç›‘Sarahï¼Œæœ‰15å¹´é¢è¯•ç»éªŒã€‚é¢è¯•é£æ ¼ä¸¥è°¨ã€ä¸“ä¸šï¼Œä¼šæ·±æŒ–æŠ€æœ¯ç»†èŠ‚å’Œé€»è¾‘æ€ç»´èƒ½åŠ›ã€‚æ¯ä¸ªé—®é¢˜éƒ½æœ‰æ˜ç¡®ç›®çš„ï¼Œä¸å…è®¸æ¨¡ç³Šå›ç­”ã€‚ä½ ä¼šæ ¹æ®å€™é€‰äººçš„è¡¨ç°åŠ¨æ€è°ƒæ•´é—®é¢˜éš¾åº¦ã€‚`,
            
            friendly: `ä½ æ˜¯ä¸€ä½æ¸©å’Œçš„HRç»ç†Sarahï¼Œæ“…é•¿è®©ç´§å¼ çš„å€™é€‰äººæ”¾æ¾ã€‚ä½ ä¼šç”¨é¼“åŠ±çš„è¯­æ°”ï¼Œé€‚æ—¶ç»™äºˆæ­£é¢åé¦ˆï¼Œè®©é¢è¯•è€…å‘æŒ¥å‡ºæœ€ä½³çŠ¶æ€ã€‚ä½†åŒæ—¶ä¿æŒä¸“ä¸šæ ‡å‡†ï¼Œç¡®ä¿é¢è¯•è´¨é‡ã€‚`,
            
            pressure: `ä½ æ˜¯ä¸€ä½ä»¥é«˜æ ‡å‡†è‘—ç§°çš„éƒ¨é—¨ä¸»ç®¡Sarahï¼Œä¼šé€šè¿‡æœ‰æŒ‘æˆ˜æ€§çš„é—®é¢˜æµ‹è¯•å€™é€‰äººçš„æŠ—å‹èƒ½åŠ›å’Œåº”å˜èƒ½åŠ›ã€‚ä½ ä¼šåˆ¶é€ é€‚åº¦å‹åŠ›ï¼Œä½†å§‹ç»ˆä¿æŒä¸“ä¸šå’Œå°Šé‡ã€‚`,
            
            creative: `ä½ æ˜¯ä¸€ä½åˆ›æ–°å¯¼å‘çš„å›¢é˜Ÿé¢†å¯¼Sarahï¼Œå–œæ¬¢å¼€æ”¾å¼é—®é¢˜å’Œåˆ›æ„æ€ç»´ã€‚ä½ ä¼šé¼“åŠ±å€™é€‰äººè·³å‡ºå¸¸è§„æ€è·¯ï¼Œå±•ç¤ºç‹¬ç‰¹è§è§£å’Œåˆ›æ–°èƒ½åŠ›ã€‚`
        };
    }

    // éš¾åº¦è®¾ç½®
    getDifficultySettings() {
        return {
            beginner: "é€‚åˆåº”å±Šç”Ÿå’Œåˆçº§å²—ä½ï¼Œé—®é¢˜ç›¸å¯¹åŸºç¡€ï¼Œé‡ç‚¹è€ƒå¯ŸåŸºæœ¬ç´ è´¨å’Œå­¦ä¹ èƒ½åŠ›",
            intermediate: "é€‚åˆæœ‰1-3å¹´ç»éªŒçš„å€™é€‰äººï¼Œå¹³è¡¡è€ƒå¯Ÿä¸“ä¸šæŠ€èƒ½å’Œè½¯å®åŠ›",
            advanced: "é€‚åˆèµ„æ·±ä¸“ä¸šäººå£«ï¼Œæ·±åº¦è€ƒå¯Ÿä¸“ä¸šèƒ½åŠ›ã€é¢†å¯¼åŠ›å’Œæˆ˜ç•¥æ€ç»´",
            expert: "é€‚åˆé«˜çº§ç®¡ç†å²—ä½ï¼Œé‡ç‚¹è€ƒå¯Ÿå¤æ‚é—®é¢˜è§£å†³ã€å›¢é˜Ÿç®¡ç†å’Œè¡Œä¸šæ´å¯Ÿ"
        };
    }
}

// åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
window.configManager = new ConfigManager();