/* PersonaHire Ultimate - é…ç½®ç®¡ç†æ¨¡å— */
/* åŒæ¨¡å¼æ§åˆ¶ + APIé…ç½® + ç³»ç»Ÿå¸¸é‡ */

// =============== å…¨å±€å˜é‡ ===============

// æ¨¡å¼æ£€æµ‹ - å¢åŠ è°ƒè¯•ä¿¡æ¯
const isDeveloperMode = window.location.search.includes('dev=true');
console.log('ğŸ”§ Mode Detection:');
console.log('URL:', window.location.href);
console.log('Search params:', window.location.search);
console.log('Developer mode:', isDeveloperMode);

// APIå¯†é’¥å˜é‡
let openaiKey = '';
let elevenKey = '';

// ä¼šè¯å˜é‡
let conversationHistory = [];
let interviewStarted = false;
let currentAudio = null;

// ç»Ÿè®¡å˜é‡
let apiCallCount = 0;
let totalTokensUsed = 0;
let responseTimes = [];
let sessionStartTime = Date.now();
let currentSessionId = `session_${Date.now()}`;

// =============== APIé…ç½®å¸¸é‡ ===============

// é¢„è®¾APIå¯†é’¥ï¼ˆç”¨æˆ·æ¨¡å¼ä½¿ç”¨ï¼‰
const DEFAULT_OPENAI_KEY = "your-openai-api-key-here";
const DEFAULT_ELEVEN_KEY = "your-elevenlabs-api-key-here";

// Tokenä»·æ ¼é…ç½®ï¼ˆåŸºäºå®˜æ–¹ä»·æ ¼ï¼‰
const TOKEN_PRICES = {
    'gpt-4.1': { input: 0.01, output: 0.03 }, // æ¯1K tokensä»·æ ¼
    'tts-1': 0.015, // æ¯1Kå­—ç¬¦ä»·æ ¼
    'tts-1-hd': 0.03,
    'eleven-labs': 0.18 // ElevenLabsæ¯1Kå­—ç¬¦ä»·æ ¼
};

// =============== é¢è¯•å®˜äººæ ¼åº“ ===============

const INTERVIEWER_PERSONALITIES = {
    professional: `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æŠ€æœ¯æ€»ç›‘Sarahï¼Œæœ‰15å¹´é¢è¯•ç»éªŒã€‚é¢è¯•é£æ ¼ä¸¥è°¨ã€ä¸“ä¸šï¼Œä¼šæ·±æŒ–æŠ€æœ¯ç»†èŠ‚å’Œé€»è¾‘æ€ç»´èƒ½åŠ›ã€‚æ¯ä¸ªé—®é¢˜éƒ½æœ‰æ˜ç¡®ç›®çš„ï¼Œä¸å…è®¸æ¨¡ç³Šå›ç­”ã€‚ä½ ä¼šæ ¹æ®å€™é€‰äººçš„è¡¨ç°åŠ¨æ€è°ƒæ•´é—®é¢˜éš¾åº¦ã€‚`,
    
    friendly: `ä½ æ˜¯ä¸€ä½æ¸©å’Œçš„HRç»ç†Sarahï¼Œæ“…é•¿è®©ç´§å¼ çš„å€™é€‰äººæ”¾æ¾ã€‚ä½ ä¼šç”¨é¼“åŠ±çš„è¯­æ°”ï¼Œé€‚æ—¶ç»™äºˆæ­£é¢åé¦ˆï¼Œè®©é¢è¯•è€…å‘æŒ¥å‡ºæœ€ä½³çŠ¶æ€ã€‚ä½†åŒæ—¶ä¿æŒä¸“ä¸šæ ‡å‡†ï¼Œç¡®ä¿é¢è¯•è´¨é‡ã€‚`,
    
    pressure: `ä½ æ˜¯ä¸€ä½ä»¥é«˜æ ‡å‡†è‘—ç§°çš„éƒ¨é—¨ä¸»ç®¡Sarahï¼Œä¼šé€šè¿‡æœ‰æŒ‘æˆ˜æ€§çš„é—®é¢˜æµ‹è¯•å€™é€‰äººçš„æŠ—å‹èƒ½åŠ›å’Œåº”å˜èƒ½åŠ›ã€‚ä½ ä¼šåˆ¶é€ é€‚åº¦å‹åŠ›ï¼Œä½†å§‹ç»ˆä¿æŒä¸“ä¸šå’Œå°Šé‡ã€‚`,
    
    creative: `ä½ æ˜¯ä¸€ä½åˆ›æ–°å¯¼å‘çš„å›¢é˜Ÿé¢†å¯¼Sarahï¼Œå–œæ¬¢å¼€æ”¾å¼é—®é¢˜å’Œåˆ›æ„æ€ç»´ã€‚ä½ ä¼šé¼“åŠ±å€™é€‰äººè·³å‡ºå¸¸è§„æ€è·¯ï¼Œå±•ç¤ºç‹¬ç‰¹è§è§£å’Œåˆ›æ–°èƒ½åŠ›ã€‚`
};

// éš¾åº¦è®¾ç½®é…ç½®
const DIFFICULTY_SETTINGS = {
    beginner: "é€‚åˆåº”å±Šç”Ÿå’Œåˆçº§å²—ä½ï¼Œé—®é¢˜ç›¸å¯¹åŸºç¡€ï¼Œé‡ç‚¹è€ƒå¯ŸåŸºæœ¬ç´ è´¨å’Œå­¦ä¹ èƒ½åŠ›",
    intermediate: "é€‚åˆæœ‰1-3å¹´ç»éªŒçš„å€™é€‰äººï¼Œå¹³è¡¡è€ƒå¯Ÿä¸“ä¸šæŠ€èƒ½å’Œè½¯å®åŠ›", 
    advanced: "é€‚åˆèµ„æ·±ä¸“ä¸šäººå£«ï¼Œæ·±åº¦è€ƒå¯Ÿä¸“ä¸šèƒ½åŠ›ã€é¢†å¯¼åŠ›å’Œæˆ˜ç•¥æ€ç»´",
    expert: "é€‚åˆé«˜çº§ç®¡ç†å²—ä½ï¼Œé‡ç‚¹è€ƒå¯Ÿå¤æ‚é—®é¢˜è§£å†³ã€å›¢é˜Ÿç®¡ç†å’Œè¡Œä¸šæ´å¯Ÿ"
};

// =============== æ¨¡å¼ç®¡ç†å‡½æ•° ===============

/**
 * åˆå§‹åŒ–åº”ç”¨æ¨¡å¼å’ŒAPIå¯†é’¥
 */
function initializeApiKeys() {
    console.log('ğŸš€ Initializing with developer mode:', isDeveloperMode);
    
    if (isDeveloperMode) {
        // å¼€å‘è€…æ¨¡å¼ï¼šæ˜¾ç¤ºAPIç®¡ç†ç•Œé¢
        setupDeveloperMode();
    } else {
        // ç”¨æˆ·æ¨¡å¼ï¼šéšè—æŠ€æœ¯å¤æ‚æ€§
        setupUserMode();
    }
}

/**
 * è®¾ç½®å¼€å‘è€…æ¨¡å¼
 */
function setupDeveloperMode() {
    console.log('ğŸ”§ Setting up developer mode...');
    
    // æ·»åŠ å¼€å‘è€…æ¨¡å¼ç±»
    document.getElementById('mainContainer').classList.add('dev-mode');
    
    // æ˜¾ç¤ºå¼€å‘è€…ä¸“ç”¨UI
    document.getElementById('apiSetup').style.display = 'block';
    document.getElementById('advancedSettings').style.display = 'block';
    
    // æ›´æ–°ç•Œé¢æ ‡è¯†
    document.getElementById('modeBadge').textContent = 'ğŸ”§ å¼€å‘è€…æ¨¡å¼';
    document.getElementById('modeBadge').style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a24)';
    document.getElementById('headerDesc').textContent = 'å®Œæ•´APIæ§åˆ¶ + Tokenç›‘æ§ç®¡ç†';
    
    // è®¾ç½®æ¨¡å¼åˆ‡æ¢é“¾æ¥
    const devModeLink = document.getElementById('devModeLink');
    devModeLink.textContent = 'ğŸ‘¤ ç”¨æˆ·æ¨¡å¼';
    devModeLink.onclick = function() {
        forceUserMode();
        return false;
    };
    
    // åŠ è½½ä¿å­˜çš„APIå¯†é’¥
    loadSavedApiKeys();
    
    console.log('âœ… Developer mode UI setup complete');
}

/**
 * è®¾ç½®ç”¨æˆ·æ¨¡å¼
 */
function setupUserMode() {
    console.log('ğŸ‘¤ Setting up user mode...');
    
    // æ·»åŠ ç”¨æˆ·æ¨¡å¼ç±»
    document.getElementById('mainContainer').classList.add('user-mode');
    
    // éšè—æŠ€æœ¯ç›¸å…³UI
    document.getElementById('apiSetup').style.display = 'none';
    document.getElementById('advancedSettings').style.display = 'none';
    
    // æ›´æ–°ç•Œé¢æ ‡è¯†
    document.getElementById('modeBadge').textContent = 'âœ¨ å³å¼€å³ç”¨ç‰ˆ';
    document.getElementById('modeBadge').style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
    
    // è®¾ç½®æ¨¡å¼åˆ‡æ¢é“¾æ¥
    const devModeLink = document.getElementById('devModeLink');
    devModeLink.textContent = 'ğŸ”§ å¼€å‘è€…æ¨¡å¼';
    devModeLink.onclick = function() {
        forceDeveloperMode();
        return false;
    };
    
    // ä½¿ç”¨é¢„è®¾APIå¯†é’¥
    openaiKey = DEFAULT_OPENAI_KEY;
    elevenKey = DEFAULT_ELEVEN_KEY;
    
    // æ£€æŸ¥é¢„è®¾å¯†é’¥æœ‰æ•ˆæ€§
    if (openaiKey && openaiKey !== "your-openai-api-key-here") {
        document.getElementById('startBtn').disabled = false;
    } else {
        showMessage('âš ï¸ ç³»ç»Ÿæ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åå†è¯•æˆ–ä½¿ç”¨å¼€å‘è€…æ¨¡å¼ã€‚', 'error');
    }
    
    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯ä¸ºç”¨æˆ·å‹å¥½ç‰ˆæœ¬
    updateWelcomeMessage();
    
    console.log('âœ… User mode UI setup complete');
}

/**
 * åŠ è½½ä¿å­˜çš„APIå¯†é’¥ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰
 */
function loadSavedApiKeys() {
    const savedOpenaiKey = localStorage.getItem('openai_api_key');
    const savedElevenKey = localStorage.getItem('eleven_api_key');
    
    if (savedOpenaiKey) {
        document.getElementById('openaiKey').value = savedOpenaiKey;
        openaiKey = savedOpenaiKey;
        document.getElementById('startBtn').disabled = false;
        
        // è‡ªåŠ¨æµ‹è¯•å·²ä¿å­˜çš„API
        setTimeout(() => {
            if (typeof testAllApis === 'function') {
                testAllApis();
            }
        }, 1000);
    }
    
    if (savedElevenKey) {
        document.getElementById('elevenKey').value = savedElevenKey;
        elevenKey = savedElevenKey;
    }
}

/**
 * æ›´æ–°ç”¨æˆ·æ¨¡å¼æ¬¢è¿æ¶ˆæ¯
 */
function updateWelcomeMessage() {
    const welcomeMsg = document.getElementById('welcomeMessage');
    if (welcomeMsg) {
        welcomeMsg.innerHTML = `
        æ¬¢è¿æ¥åˆ°PersonaHire Ultimateï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±AIé¢è¯•å®˜Sarahã€‚
        <br><br>
        ğŸ¯ <strong>å³å¼€å³ç”¨</strong> - æ— éœ€ä»»ä½•é…ç½®ï¼Œç«‹å³å¼€å§‹ä¸“ä¸šé¢è¯•ä½“éªŒ
        <br>ğŸ¤– <strong>GPT-4.1é©±åŠ¨</strong> - æœ€å…ˆè¿›çš„AIæ¨ç†å¼•æ“
        <br>ğŸµ <strong>çœŸäººè¯­éŸ³</strong> - æ¥è¿‘çœŸå®é¢è¯•å®˜çš„è¯­éŸ³äº¤äº’
        <br>ğŸ“Š <strong>ä¸“ä¸šè¯„ä¼°</strong> - å¤šç»´åº¦é¢è¯•è¡¨ç°åˆ†æ
        <br><br>
        è¯·é€‰æ‹©æ‚¨æƒ³è¦çš„é¢è¯•é£æ ¼å’Œéš¾åº¦ï¼Œç„¶åç‚¹å‡»"å¼€å§‹é¢è¯•"ï¼
        `;
    }
}

// =============== æ¨¡å¼åˆ‡æ¢å‡½æ•° ===============

/**
 * å¼ºåˆ¶åˆ‡æ¢åˆ°å¼€å‘è€…æ¨¡å¼
 */
function forceDeveloperMode() {
    console.log('ğŸ”§ Forcing developer mode...');
    const newUrl = window.location.pathname + '?dev=true';
    console.log('Redirecting to:', newUrl);
    window.location.href = newUrl;
}

/**
 * å¼ºåˆ¶åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼
 */
function forceUserMode() {
    console.log('ğŸ‘¤ Forcing user mode...');
    const newUrl = window.location.pathname;
    console.log('Redirecting to:', newUrl);
    window.location.href = newUrl;
}

// =============== APIå¯†é’¥ç®¡ç† ===============

/**
 * ä¿å­˜APIå¯†é’¥é…ç½®ï¼ˆä»…å¼€å‘è€…æ¨¡å¼ï¼‰
 */
function saveApiKeys() {
    const openaiInput = document.getElementById('openaiKey');
    const elevenInput = document.getElementById('elevenKey');
    
    openaiKey = openaiInput.value.trim();
    elevenKey = elevenInput.value.trim();
    
    if (openaiKey && openaiKey.startsWith('sk-')) {
        localStorage.setItem('openai_api_key', openaiKey);
        if (elevenKey) {
            localStorage.setItem('eleven_api_key', elevenKey);
        }
        showMessage('âœ… APIé…ç½®ä¿å­˜æˆåŠŸï¼æ­£åœ¨æµ‹è¯•è¿æ¥...', 'success');
        document.getElementById('startBtn').disabled = false;
        
        // è‡ªåŠ¨æµ‹è¯•è¿æ¥
        setTimeout(() => {
            if (typeof testAllApis === 'function') {
                testAllApis();
            }
        }, 500);
    } else {
        showError('è¯·è¾“å…¥æœ‰æ•ˆçš„OpenAI API Key (ä»¥sk-å¼€å¤´)');
    }
}

/**
 * æ¸…é™¤ä¿å­˜çš„APIå¯†é’¥
 */
function clearApiKeys() {
    localStorage.removeItem('openai_api_key');
    localStorage.removeItem('eleven_api_key');
    
    document.getElementById('openaiKey').value = '';
    document.getElementById('elevenKey').value = '';
    
    openaiKey = '';
    elevenKey = '';
    
    showMessage('ğŸ—‘ï¸ APIå¯†é’¥å·²æ¸…é™¤', 'success');
}

// =============== é«˜çº§è®¾ç½®ç®¡ç† ===============

/**
 * åˆå§‹åŒ–é«˜çº§è®¾ç½®ï¼ˆä»…å¼€å‘è€…æ¨¡å¼ï¼‰
 */
function initAdvancedSettings() {
    if (!isDeveloperMode) return;
    
    const tempSlider = document.getElementById('temperature');
    const tempValue = document.getElementById('tempValue');
    
    if (tempSlider && tempValue) {
        tempSlider.addEventListener('input', (e) => {
            tempValue.textContent = e.target.value;
        });
    }
}

/**
 * è·å–å½“å‰é«˜çº§è®¾ç½®å‚æ•°
 */
function getAdvancedSettings() {
    if (!isDeveloperMode) {
        return {
            temperature: 0.7,
            maxTokens: 800,
            ttsModel: 'tts-1',
            debugMode: false
        };
    }
    
    return {
        temperature: parseFloat(document.getElementById('temperature')?.value || 0.7),
        maxTokens: parseInt(document.getElementById('maxTokens')?.value || 800),
        ttsModel: document.getElementById('ttsModel')?.value || 'tts-1',
        debugMode: document.getElementById('debugMode')?.value === 'on'
    };
}

// =============== ç³»ç»Ÿä¿¡æ¯å’Œè°ƒè¯• ===============

/**
 * æ˜¾ç¤ºç³»ç»Ÿè°ƒè¯•ä¿¡æ¯
 */
function showDebugInfo() {
    const debugInfo = {
        mode: isDeveloperMode ? 'Developer' : 'User',
        apiCallCount: apiCallCount,
        tokensUsed: totalTokensUsed,
        sessionTime: Math.round((Date.now() - sessionStartTime) / 1000) + 's',
        conversationLength: conversationHistory.length,
        browserInfo: navigator.userAgent.split(' ').slice(-2).join(' '),
        timestamp: new Date().toLocaleString(),
        currentURL: window.location.href,
        hasDevParam: window.location.search.includes('dev=true'),
        sessionId: currentSessionId
    };
    
    const debugText = Object.entries(debugInfo)
        .map(([key, value]) => `${key}: ${value}`)
        .join('\n');
        
    alert('ğŸ› ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯:\n\n' + debugText);
}

/**
 * ç”Ÿæˆæ–°çš„ä¼šè¯ID
 */
function generateNewSessionId() {
    currentSessionId = `session_${Date.now()}`;
    console.log('ğŸ†” New session ID:', currentSessionId);
    return currentSessionId;
}

// =============== é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ˜¾ç¤º ===============

/**
 * æ˜¾ç¤ºæ¶ˆæ¯æç¤º
 */
function showMessage(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    if (statusDiv) {
        statusDiv.className = type;
        statusDiv.innerHTML = message;
        statusDiv.style.display = 'block';
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

/**
 * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
 */
function showError(message) {
    showMessage(message, 'error');
}

/**
 * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
 */
function showSuccess(message) {
    showMessage(message, 'success');
}

// =============== æ¨¡å—å¯¼å‡º ===============

// ç¡®ä¿å…¨å±€å¯è®¿é—®çš„å‡½æ•°
window.initializeApiKeys = initializeApiKeys;
window.saveApiKeys = saveApiKeys;
window.clearApiKeys = clearApiKeys;
window.forceDeveloperMode = forceDeveloperMode;
window.forceUserMode = forceUserMode;
window.showDebugInfo = showDebugInfo;
window.getAdvancedSettings = getAdvancedSettings;
window.initAdvancedSettings = initAdvancedSettings;
window.generateNewSessionId = generateNewSessionId;
window.showMessage = showMessage;
window.showError = showError;
window.showSuccess = showSuccess;

console.log('âœ… Config module loaded successfully');