<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonaHire Ultimate - 专业AI面试平台</title>
    <meta name="description" content="基于GPT-4.1和ElevenLabs TTS的AI面试官平台，提供专业的面试模拟体验">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            color: #1a1a1a;
            line-height: 1.6;
        }

        /* 头部 */
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2563eb;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f0f9ff;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: 1px solid #e0f2fe;
            color: #0369a1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* 主容器 */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* 标题区域 */
        .title-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 1rem;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
        }

        .mode-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* 主卡片 */
        .main-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 设置面板 */
        .settings-panel {
            background: #f8fafc;
            padding: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1.5rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .setting-select {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
            font-size: 0.9rem;
            color: #374151;
            transition: all 0.2s ease;
        }

        .setting-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* 聊天区域 */
        .chat-section {
            padding: 2rem;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #fafbfc;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .message {
            margin-bottom: 1.5rem;
            max-width: 80%;
        }

        .message.ai {
            margin-right: auto;
        }

        .message.user {
            margin-left: auto;
        }

        .message-header {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message.ai .message-header {
            color: #2563eb;
        }

        .message.user .message-header {
            color: #059669;
            justify-content: flex-end;
        }

        .message-content {
            background: #fff;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.ai .message-content {
            border-left: 3px solid #2563eb;
        }

        .message.user .message-content {
            border-right: 3px solid #059669;
            background: #f0fdf4;
        }

        .voice-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .voice-btn {
            background: #ff4081;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .voice-btn:hover {
            background: #e91e63;
            transform: scale(1.05);
        }

        /* 输入区域 */
        .input-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .input-textarea {
            flex: 1;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .input-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-button {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .send-button:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* 控制按钮 */
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #fff;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .control-btn.primary {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
        }

        .control-btn.primary:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .audio-indicator {
            display: none;
            color: #ff4081;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 状态消息 */
        .status-message {
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        /* 底部链接 */
        .footer-links {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid #e5e7eb;
        }

        .footer-links a {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9rem;
            margin: 0 1rem;
            transition: color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-links a:hover {
            color: #2563eb;
        }

        .footer-separator {
            color: #d1d5db;
            margin: 0 0.5rem;
        }

        /* 调试信息 */
        .debug-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info.show {
            display: block;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .main-title {
                font-size: 2rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .input-section {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 300px;
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }

            .footer-links a {
                display: block;
                margin: 0.5rem 0;
            }

            .footer-separator {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">PersonaHire Ultimate</div>
            <div class="header-status" id="headerStatus">
                <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span>
                GPT-4.1 + ElevenLabs TTS
            </div>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="container">
        <!-- 标题区域 -->
        <section class="title-section">
            <div class="mode-indicator" id="modeIndicator">
                ✨ 即开即用版 - 零配置启动
            </div>
            <h1 class="main-title">AI面试官平台</h1>
            <p class="subtitle">
                专业的人工智能面试模拟系统，帮助您提升面试表现，
                采用最先进的GPT-4.1推理引擎和ElevenLabs语音合成技术。
            </p>
        </section>

        <!-- 状态消息 -->
        <div class="status-message" id="statusMessage"></div>

        <!-- 主卡片 -->
        <div class="main-card">
            <!-- 设置面板 -->
            <div class="settings-panel">
                <h3 class="settings-title">面试设置</h3>
                <div class="settings-grid">
                    <div class="setting-group">
                        <label class="setting-label">面试官风格</label>
                        <select class="setting-select" id="interviewerStyle">
                            <option value="friendly">友好鼓励型</option>
                            <option value="professional">专业严谨型</option>
                            <option value="pressure">压力测试型</option>
                            <option value="creative">创意开放型</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">面试难度</label>
                        <select class="setting-select" id="difficulty">
                            <option value="beginner">初级难度</option>
                            <option value="intermediate">中级难度</option>
                            <option value="advanced">高级难度</option>
                            <option value="expert">专家难度</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">语音风格</label>
                        <select class="setting-select" id="voiceStyle">
                            <option value="nova">Nova (女性)</option>
                            <option value="alloy">Alloy (中性)</option>
                            <option value="echo">Echo (男性)</option>
                            <option value="fable">Fable (英国口音)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 聊天区域 -->
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message ai">
                        <div class="message-header">
                            🤖 AI面试官 Sarah
                        </div>
                        <div class="message-content" id="welcomeMessage">
                            欢迎使用PersonaHire Ultimate！我是您的专属AI面试官Sarah。
                            <br><br>
                            <strong>核心特性：</strong><br>
                            • 基于GPT-4.1的深度推理能力<br>
                            • ElevenLabs真人级语音合成<br>
                            • 个性化面试风格调整<br>
                            • 专业的面试表现评估
                            <br><br>
                            请配置您的面试偏好，然后点击"开始面试"。我会根据您的设置提供最适合的面试体验。
                        </div>
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playWelcomeMessage()">🔊 听语音欢迎</button>
                        </div>
                    </div>
                </div>

                <!-- 输入区域 -->
                <div class="input-section">
                    <textarea 
                        class="input-textarea" 
                        id="messageInput" 
                        placeholder="请输入您的回答..."
                        disabled
                    ></textarea>
                    <button class="send-button" id="sendBtn" disabled>
                        发送回答
                    </button>
                </div>

                <!-- 控制按钮 -->
                <div class="controls">
                    <button class="control-btn primary" id="startBtn">
                        开始面试
                    </button>
                    <button class="control-btn" id="reportBtn" disabled>
                        生成报告
                    </button>
                    <button class="control-btn" id="endBtn" disabled>
                        结束面试
                    </button>
                    <button class="control-btn" id="clearBtn">
                        清空对话
                    </button>
                </div>

                <!-- 加载状态 -->
                <div class="loading" id="loading">
                    <div class="audio-indicator" id="audioIndicator">🎵 正在生成语音...</div>
                    <div class="loading-spinner"></div>
                    AI面试官正在分析您的回答...
                </div>
            </div>
        </div>

        <!-- 调试信息 -->
        <div class="debug-info" id="debugInfo">
            <strong>🔍 调试信息:</strong>
            <div id="debugContent">系统启动完成</div>
        </div>

        <!-- 底部链接 -->
        <div class="footer-links">
            <a href="?dev=true" id="devModeLink">
                🔧 开发者模式
            </a>
            <span class="footer-separator">|</span>
            <a href="https://github.com/Kyle-Wang0211/PersonaHire-Ultimate" target="_blank">
                💻 查看源码
            </a>
            <span class="footer-separator">|</span>
            <a href="mailto:wkd20040211@gmail.com">
                📧 联系作者
            </a>
            <span class="footer-separator">|</span>
            <a href="#" onclick="toggleDebug()">
                🐛 调试信息
            </a>
        </div>
    </div>

    <script>
        // 全局变量
        let openaiKey = '';
        let elevenKey = '';
        let conversationHistory = [];
        let interviewStarted = false;
        let currentAudio = null;
        let lastQuestions = [];
        
        // 模式检测
        const isDeveloperMode = window.location.search.includes('dev=true');
        
        // 预设API密钥
        const DEFAULT_OPENAI_KEY = "your-openai-api-key-here";
        const DEFAULT_ELEVEN_KEY = "your-elevenlabs-api-key-here";

        // 面试官人格库
        const INTERVIEWER_PERSONALITIES = {
            professional: `你是一位资深的技术总监Sarah，有15年面试经验。面试风格严谨、专业，会深挖技术细节和逻辑思维能力。每个问题都有明确目的，不允许模糊回答。你会根据候选人的表现动态调整问题难度。`,
            
            friendly: `你是一位温和的HR经理Sarah，擅长让紧张的候选人放松。你会用鼓励的语气，适时给予正面反馈，让面试者发挥出最佳状态。但同时保持专业标准，确保面试质量。`,
            
            pressure: `你是一位以高标准著称的部门主管Sarah，会通过有挑战性的问题测试候选人的抗压能力和应变能力。你会制造适度压力，但始终保持专业和尊重。`,
            
            creative: `你是一位创新导向的团队领导Sarah，喜欢开放式问题和创意思维。你会鼓励候选人跳出常规思路，展示独特见解和创新能力。`
        };

        const DIFFICULTY_SETTINGS = {
            beginner: "适合应届生和初级岗位，问题相对基础，重点考察基本素质和学习能力",
            intermediate: "适合有1-3年经验的候选人，平衡考察专业技能和软实力", 
            advanced: "适合资深专业人士，深度考察专业能力、领导力和战略思维",
            expert: "适合高级管理岗位，重点考察复杂问题解决、团队管理和行业洞察"
        };

        // 统一按钮状态管理函数
        function updateButtonStates(state) {
            try {
                const startBtn = document.getElementById('startBtn');
                const sendBtn = document.getElementById('sendBtn');
                const reportBtn = document.getElementById('reportBtn');
                const endBtn = document.getElementById('endBtn');
                const messageInput = document.getElementById('messageInput');
                const clearBtn = document.getElementById('clearBtn');

                if (!startBtn || !sendBtn || !reportBtn || !endBtn || !messageInput || !clearBtn) {
                    debugLog('按钮元素未找到');
                    return;
                }

                switch(state) {
                    case 'waiting':
                        startBtn.disabled = false;
                        startBtn.textContent = '开始面试';
                        sendBtn.disabled = true;
                        reportBtn.disabled = true;
                        endBtn.disabled = true;
                        messageInput.disabled = true;
                        clearBtn.disabled = false;
                        break;
                        
                    case 'active':
                        startBtn.disabled = true;
                        startBtn.textContent = '面试进行中...';
                        sendBtn.disabled = false;
                        reportBtn.disabled = false;
                        endBtn.disabled = false;
                        messageInput.disabled = false;
                        clearBtn.disabled = false;
                        break;
                        
                    case 'ended':
                        startBtn.disabled = false;
                        startBtn.textContent = '开始面试';
                        sendBtn.disabled = true;
                        reportBtn.disabled = false;
                        endBtn.disabled = true;
                        messageInput.disabled = true;
                        clearBtn.disabled = false;
                        break;
                        
                    case 'loading':
                        startBtn.disabled = true;
                        sendBtn.disabled = true;
                        reportBtn.disabled = true;
                        endBtn.disabled = true;
                        clearBtn.disabled = true;
                        break;
                }
                
                debugLog(`按钮状态更新为: ${state}`);
            } catch (error) {
                debugLog(`按钮状态更新失败: ${error.message}`);
            }
        }

        // 调试功能
        function debugLog(message) {
            try {
                const debugContent = document.getElementById('debugContent');
                if (debugContent) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugContent.innerHTML += `<br>[${timestamp}] ${message}`;
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
                console.log(`[PersonaHire Debug] ${message}`);
            } catch (error) {
                console.log(`[PersonaHire Debug Error] ${error.message}`);
            }
        }

        function toggleDebug() {
            try {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.classList.toggle('show');
                }
            } catch (error) {
                debugLog(`调试面板切换失败: ${error.message}`);
            }
        }

        // 初始化
        function initializeApp() {
            debugLog('应用初始化开始');
            try {
                initializeApiKeys();
                setupEventListeners();
                updateButtonStates('waiting');
                debugLog('应用初始化完成');
            } catch (error) {
                debugLog(`应用初始化失败: ${error.message}`);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            try {
                document.getElementById('startBtn').addEventListener('click', startInterview);
                document.getElementById('sendBtn').addEventListener('click', sendMessage);
                document.getElementById('reportBtn').addEventListener('click', generateReport);
                document.getElementById('endBtn').addEventListener('click', endInterview);
                document.getElementById('clearBtn').addEventListener('click', clearChat);
                
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                debugLog('事件监听器设置完成');
            } catch (error) {
                debugLog(`事件监听器设置失败: ${error.message}`);
            }
        }

        // API密钥初始化
        function initializeApiKeys() {
            try {
                const savedOpenaiKey = localStorage.getItem('openai_api_key');
                const savedElevenKey = localStorage.getItem('eleven_api_key');
                
                if (savedOpenaiKey) {
                    openaiKey = savedOpenaiKey;
                }
                
                if (savedElevenKey) {
                    elevenKey = savedElevenKey;
                }
                
                if (!openaiKey) {
                    openaiKey = DEFAULT_OPENAI_KEY;
                }
                if (!elevenKey) {
                    elevenKey = DEFAULT_ELEVEN_KEY;
                }
                
                if (openaiKey && openaiKey !== "your-openai-api-key-here") {
                    debugLog('API密钥配置完成');
                } else {
                    showMessage('⚠️ 系统正在维护中，请稍后再试或使用开发者模式。', 'error');
                    debugLog('API密钥未配置');
                }
            } catch (error) {
                debugLog(`API密钥初始化失败: ${error.message}`);
            }
        }

        // 显示状态消息
        function showMessage(message, type = 'info') {
            try {
                const statusDiv = document.getElementById('statusMessage');
                if (statusDiv) {
                    statusDiv.className = `status-message ${type}`;
                    statusDiv.innerHTML = message;
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            } catch (error) {
                debugLog(`显示消息失败: ${error.message}`);
            }
        }

        // 简单的重复检测
        function isQuestionRepeated(question) {
            try {
                const keywords = question.toLowerCase().match(/[\u4e00-\u9fa5]+|[a-zA-Z]+/g) || [];
                const questionSignature = keywords.slice(0, 3).join('');
                
                const isRepeated = lastQuestions.some(q => {
                    return questionSignature.includes(q) || q.includes(questionSignature);
                });
                
                if (!isRepeated && questionSignature.length > 0) {
                    lastQuestions.push(questionSignature);
                    if (lastQuestions.length > 3) {
                        lastQuestions.shift();
                    }
                }
                
                debugLog(`问题重复检测: ${isRepeated ? '重复' : '新问题'}`);
                return isRepeated;
            } catch (error) {
                debugLog(`重复检测失败: ${error.message}`);
                return false;
            }
        }

        // GPT-4.1 API调用
        async function callGPT41(messages) {
            try {
                debugLog(`发送API请求，消息数量: ${messages.length}`);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: messages,
                        max_tokens: 800,
                        temperature: 0.8,
                        presence_penalty: 0.2,
                        frequency_penalty: 0.1
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || '请求失败');
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                debugLog(`API响应成功，长度: ${aiResponse.length}`);
                return aiResponse;
            } catch (error) {
                debugLog(`API调用失败: ${error.message}`);
                throw error;
            }
        }

        // 语音合成
        async function generateSpeech(text) {
            try {
                debugLog('开始语音合成');
                
                if (!elevenKey || elevenKey === "your-elevenlabs-api-key-here") {
                    try {
                        const response = await fetch('https://api.openai.com/v1/audio/speech', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${openaiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                model: 'tts-1',
                                voice: document.getElementById('voiceStyle')?.value || 'nova',
                                input: text,
                                speed: 1.0
                            })
                        });

                        if (response.ok) {
                            const audioBlob = await response.blob();
                            debugLog('OpenAI TTS合成成功');
                            return URL.createObjectURL(audioBlob);
                        }
                    } catch (error) {
                        debugLog(`OpenAI TTS失败: ${error.message}`);
                    }
                    return null;
                }

                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM', {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': elevenKey
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.8,
                            style: 0.3,
                            use_speaker_boost: true
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    debugLog('ElevenLabs TTS合成成功');
                    return URL.createObjectURL(audioBlob);
                }
            } catch (error) {
                debugLog(`语音合成失败: ${error.message}`);
            }
            return null;
        }

        // 播放音频
        async function playAudio(text) {
            try {
                if (currentAudio) {
                    currentAudio.pause();
                }

                const audioIndicator = document.getElementById('audioIndicator');
                if (audioIndicator) {
                    audioIndicator.style.display = 'block';
                }

                const audioUrl = await generateSpeech(text);
                if (audioUrl) {
                    currentAudio = new Audio(audioUrl);
                    currentAudio.play();
                    
                    currentAudio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                        debugLog('音频播放完成');
                    };
                }
            } catch (error) {
                debugLog(`音频播放失败: ${error.message}`);
            } finally {
                const audioIndicator = document.getElementById('audioIndicator');
                if (audioIndicator) {
                    audioIndicator.style.display = 'none';
                }
            }
        }

        // 开始面试
        async function startInterview() {
            try {
                debugLog('开始面试');
                
                if (!openaiKey || openaiKey === "your-openai-api-key-here") {
                    showMessage('请先配置OpenAI API Key', 'error');
                    return;
                }

                const style = document.getElementById('interviewerStyle').value;
                const difficulty = document.getElementById('difficulty').value;

                lastQuestions = [];
                updateButtonStates('loading');
                
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'block';

                const systemPrompt = `${INTERVIEWER_PERSONALITIES[style]}

面试难度: ${DIFFICULTY_SETTINGS[difficulty]}

面试规则：
1. 一次只问一个问题，等候选人回答完再问下一个
2. 根据候选人的回答进行3-5轮深度追问
3. 记住之前的所有对话内容，形成连贯的面试体验
4. 每个问题都要有明确的考察目的
5. 面试总时长控制在15-20分钟
6. 适时给予反馈和鼓励
7. 最后要给出综合评价

请用中文进行面试，保持专业但友好的语气。现在开始第一个问题。`;

                conversationHistory = [
                    { role: 'system', content: systemPrompt }
                ];

                const response = await callGPT41(conversationHistory);
                conversationHistory.push({ role: 'assistant', content: response });
                
                addMessage(response, 'ai');
                await playAudio(response);
                
                interviewStarted = true;
                updateButtonStates('active');
                
                debugLog('面试开始成功');
            } catch (error) {
                debugLog(`面试开始失败: ${error.message}`);
                showMessage('启动面试失败: ' + error.message, 'error');
                updateButtonStates('waiting');
            } finally {
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }

        // 发送消息
        async function sendMessage() {
            try {
                const userInput = document.getElementById('messageInput');
                const message = userInput.value.trim();

                if (!message) return;

                debugLog(`用户发送消息: ${message.substring(0, 30)}...`);

                addMessage(message, 'user');
                userInput.value = '';
                
                updateButtonStates('loading');
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'block';

                conversationHistory.push({ role: 'user', content: message });

                const response = await callGPT41(conversationHistory);
                
                if (isQuestionRepeated(response)) {
                    debugLog('检测到重复问题，重新生成');
                    const retryMessages = [...conversationHistory, {
                        role: 'system',
                        content: '请提出一个不同的新问题，避免重复之前的内容。'
                    }];
                    const retryResponse = await callGPT41(retryMessages);
                    conversationHistory.push({ role: 'assistant', content: retryResponse });
                    addMessage(retryResponse, 'ai');
                    await playAudio(retryResponse);
                } else {
                    conversationHistory.push({ role: 'assistant', content: response });
                    addMessage(response, 'ai');
                    await playAudio(response);
                }
                
                debugLog('消息发送成功');
            } catch (error) {
                debugLog(`消息发送失败: ${error.message}`);
                showMessage('发送消息失败: ' + error.message, 'error');
                addMessage('抱歉，我遇到了一些技术问题。请稍后再试。', 'ai');
            } finally {
                updateButtonStates('active');
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }

        // 生成报告
        async function generateReport() {
            try {
                debugLog('开始生成面试报告');
                
                if (conversationHistory.length < 4) {
                    showMessage('面试内容太少，无法生成有效报告。请至少进行3轮对话。', 'error');
                    return;
                }

                updateButtonStates('loading');
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'block';

                const reportPrompt = `基于以上完整的面试对话，请生成一份专业的面试评估报告。报告应包括：

1. 候选人整体表现概述
2. 核心能力评估（技能、沟通、逻辑思维、应变能力等）
3. 具体优势和亮点
4. 需要改进的方面
5. 面试表现打分（1-10分，各维度详细说明）
6. 录用建议（推荐/有条件推荐/不推荐）
7. 针对性的职业发展建议

请用专业、客观、建设性的语言撰写，报告要具体、有针对性。`;

                const reportHistory = [...conversationHistory, { role: 'user', content: reportPrompt }];
                const report = await callGPT41(reportHistory);
                
                addMessage(`📊 **面试评估报告**\n\n${report}`, 'ai');
                await playAudio('您的专业面试评估报告已经生成完成，请查看详细分析和建议。');
                
                showMessage('✅ 面试报告生成成功！', 'success');
                debugLog('面试报告生成成功');
            } catch (error) {
                debugLog(`报告生成失败: ${error.message}`);
                showMessage('生成报告失败: ' + error.message, 'error');
            } finally {
                updateButtonStates(interviewStarted ? 'active' : 'ended');
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }

        // 结束面试
        function endInterview() {
            try {
                debugLog('结束面试');
                
                interviewStarted = false;
                updateButtonStates('ended');
                
                addMessage('面试结束，感谢您的参与！如需查看详细评估，请点击"生成报告"按钮。', 'ai');
                playAudio('面试结束，感谢您的参与！');
                
                debugLog('面试结束成功');
            } catch (error) {
                debugLog(`结束面试失败: ${error.message}`);
            }
        }

        // 清空对话
        function clearChat() {
            try {
                debugLog('清空对话');
                
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.innerHTML = `
                        <div class="message ai">
                            <div class="message-header">🤖 AI面试官 Sarah</div>
                            <div class="message-content">
                                欢迎使用PersonaHire Ultimate！我是您的专属AI面试官Sarah。请配置好设置后点击"开始面试"。
                            </div>
                            <div class="voice-controls">
                                <button class="voice-btn" onclick="playWelcomeMessage()">🔊 听语音欢迎</button>
                            </div>
                        </div>
                    `;
                }
                
                conversationHistory = [];
                lastQuestions = [];
                interviewStarted = false;
                updateButtonStates('waiting');
                
                debugLog('对话清空成功');
            } catch (error) {
                debugLog(`清空对话失败: ${error.message}`);
            }
        }

        // 添加消息
        function addMessage(content, sender) {
            try {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const senderName = sender === 'ai' ? '🤖 AI面试官 Sarah' : '👤 您的回答';
                let messageHTML = `
                    <div class="message-header">${senderName}</div>
                    <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                `;
                
                if (sender === 'ai') {
                    messageHTML += `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="playAudio('${content.replace(/'/g, "\\'")}')">🔊 重播语音</button>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = messageHTML;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                debugLog(`添加消息: ${sender} - ${content.substring(0, 30)}...`);
            } catch (error) {
                debugLog(`添加消息失败: ${error.message}`);
            }
        }

        // 播放欢迎消息
        async function playWelcomeMessage() {
            const welcomeText = "欢迎来到PersonaHire Ultimate！我是您的专属AI面试官Sarah，搭载了最强大的GPT-4.1推理引擎。让我们开始一场精彩的面试吧！";
            await playAudio(welcomeText);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>